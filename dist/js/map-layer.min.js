/*!
 * map-layer.js
 * https://github.com/Lyxea/map-layers.js
 * Version: 0.2
 *
 * Copyright 2018 Map-layers.js Contributors
 * Released under the Apache License 2.0
 * https://github.com/Lyxea/map-layers.js/blob/master/LICENSE
 */
jQuery.fn.centerHorizontal=function(){this.css("position","absolute");$(".map").width();return this},jQuery.fn.centerVertical=function(){return this.css("position","absolute"),this.css("top",Math.max(0,($(".map").height()-$(this).outerHeight())/2+$(".map").scrollTop())+"px"),this};var dimensionSlider=function(n,o){var l,s,d=this,a=new Date("1990-11-25T12:00:00.000Z"),p=[],u=[],c={},f={};n=n,o=o;this.resetDimensionSlider=function(){p=[],u=[],c={},{},f={}},this.setCallbackUpdateParam=function(e){l=e},this.setCallbackChangeVisiblity=function(e){s=e};var y=function(e){return date=new Date(e),val=(date-a)/36e5,val},i=function(e,a,t){void 0!==a&&$.each(a.Dimension,function(e,i){currentVal=i.values.split(","),$.each(currentVal,function(e,a){"time"==i.name?t(c,a,u):"elevation"==i.name&&t(f,parseInt(a),p)})})};this.sliderAddLayer=function(t,e){void 0!==e&&void 0!==e.Dimension&&i(0,e,function(e,a,i){$.inArray(t,i)<0&&i.push(t),e[a]||(e[a]=[]),$.inArray(t,e[a])<0&&e[a].push(t)})},this.sliderRemoveLayer=function(t,e){u=jQuery.grep(u,function(e){return e!=t}),p=jQuery.grep(p,function(e){return e!=t}),i(0,e,function(e,a,i){e[a]&&(e[a]=jQuery.grep(e[a],function(e){return e!=t}),e[a].length<=0&&delete e[a])})},this.updateElevSlider=function(e){var i=Object.keys(f),a=$("#slider_layer_input").val();if($("#"+n).html(""),$("#"+n).hide(),!(i.length<=1)){""!=a&&null!=a||(a=Math.min.apply(null,i));if(void 0!==$("#"+o).find("#slider_time_input"))$("#"+o).find("#slider_time_input").val();$("#"+n).show(),$("#"+n).append("<span class='textColor1'>"+trans.level+"</span><i class='fa fa-caret-up fa-2x sl-up color1Hover' id='up_elev' aria-hidden='true'></i><input id='slider_layer_input' class='dim2-slider'><i class='fa fa-caret-down fa-2x color1Hover sl-down' id='down_elev' aria-hidden='true'></i>");$("#slider_layer_input").slider({value:a,step:1,min:Math.min.apply(null,i),max:Math.max.apply(null,i),ticks:i,orientation:"vertical"}).on("slideStop",function(){$.each(u,function(e,a){d.updateLayer(a)})});$("#"+n).centerVertical(),$("#slider_layer_input").trigger("slideStop"),$("#"+n).find("#down_elev").click(function(){if(!($("#slider_layer_input").val()>=Math.max.apply(null,i))){var e=$("#slider_layer_input").val(),a=i[e];$("#slider_layer_input").slider("setValue",a),$("#slider_layer_input").trigger("slideStop")}}),$("#"+n).find("#up_elev").click(function(){if(!($("#slider_layer_input").val()<=Math.min.apply(null,i))){var e=$("#slider_layer_input").val(),a=i[e-2];$("#slider_layer_input").slider("setValue",a),$("#slider_layer_input").trigger("slideStop")}})}},this.updateTimeSlider=function(e){var a=Object.keys(c),i=[];$.each(a,function(e,a){i.push(y(a))});var t={};$.each(c,function(e,a){var i=y(e).toString()+" ";t[i]||(t[i]=[]),$.each(a,function(e,a){t[i].push(a)})});var r=$("#slider_time_input").val();if($("#"+o).html(""),$("#"+o).hide(),!(i.length<=1)){""!=r&&null!=r||(r=Math.min.apply(null,i));if(void 0!==$("#"+n).find("#slider_layer_input"))$("#"+n).find("#slider_layer_input").val();$("#"+o).show(),$("#"+o).append("<span class='textColor1 col-md-2'>"+trans.time+"</span> <span class='col-md-10'><i class='fa fa-caret-left fa-2x sl-left color1Hover' id='down_time' aria-hidden='true'></i><input id='slider_time_input'><i class='fa fa-caret-right fa-2x color1Hover sl-right' id='up_time' aria-hidden='true'></i></span>"),$("#slider_time_input").slider({value:r,step:1,min:Math.min.apply(null,i),max:Math.max.apply(null,i)}).on("slideStop",function(){$.each(p,function(e,a){d.updateLayer(a)})}),$("#"+o).centerHorizontal(),$("#slider_time_input").trigger("slideStop"),$("#"+o).find("#down_time").click(function(){if(!($("#slider_time_input").val()<=Math.min.apply(null,i))){var e=i[$("#slider_time_input").val()-1];$("#slider_time_input").slider("setValue",e),$("#slider_time_input").trigger("slideStop")}}),$("#"+o).find("#up_time").click(function(){if(!($("#slider_time_input").val()>=Math.max.apply(null,i))){var e=i[parseInt($("#slider_time_input").val())+1];$("#slider_time_input").slider("setValue",e),$("#slider_time_input").trigger("slideStop")}})}},this.updateLayer=function(i){if(!($.inArray(i,p)<0&&$.inArray(i,u)<0)){var t,e,r=!1,a=!1;void 0!==$("#"+o).find("#slider_time_input")&&(t=$("#"+o).find("#slider_time_input").val()),void 0!==$("#"+n).find("#slider_layer_input")&&(e=$("#"+n).find("#slider_layer_input").val()),$.each(c,function(e,a){t==y(e)&&0<=$.inArray(i,a)&&(r=!0,l(i,"TIME",e))}),f[e]&&0<=$.inArray(i,f[e])&&(a=!0,l(i,"ELEVATION",e)),0!=a&&0!=r||s(i,!1)}}},geoMap=function(i,e,a){this.mapDiv=i,this.geoServerURL=e;var n,o,l,s,d=this,t=ol.proj.transform([2,45.07],"EPSG:4326","EPSG:3857"),r=13,p=new Map,u=0,c=(new Map,""),f={},y="OSM",v=[],g=!0,m=document.getElementById("popup"),h=document.getElementById("popup-content"),b=document.getElementById("popup-closer"),L=new ol.Overlay({element:m,autoPan:!0,autoPanAnimation:{duration:250}});this.initMap=function(e){void 0===e.defaultBaseMap&&""==e.defaultBaseMap||(y=e.defaultBaseMap),void 0===e.defaultZoomLevel&&""==e.defaultZoomLevel||(r=e.defaultZoomLevel),void 0===e.defaultXCenter&&""==e.defaultXCenter||void 0===e.defaultYCenter&&""==e.defaultYCenter||(t=ol.proj.transform([parseFloat(e.defaultXCenter),parseFloat(e.defaultYCenter)],"EPSG:4326","EPSG:3857")),d.initBaseMap();var a=new ol.control.ScaleLine;t=t,(n=new ol.Map({layers:void 0,target:i,view:new ol.View({center:t,zoom:r}),controls:[]})).addControl(a),$.each(f,function(e,a){e==y&&(a.setVisible(!0),p.set(0,a)),n.addLayer(a)}),C()};var M=void 0,w=void 0;this.asMeasureInteractive=function(){return null!=M},this.createMeasureLayer=function(t){(w=new ol.layer.Vector({source:new ol.source.Vector})).setZIndex(9998),n.addLayer(w),M=new ol.interaction.Draw({type:t,source:w.getSource()}),l&&l.parentNode.removeChild(l),(l=document.createElement("div")).className="tooltip tooltip-measure",o=new ol.Overlay({element:l,offset:[0,-15],positioning:"bottom-center"}),n.addOverlay(o);var r="Polygon"===t?"<sup>2</sup>":"";M.on("drawstart",function(e){w.getSource().clear(),e.feature.on("change",function(e){var a="Polygon"===t?e.target.getGeometry().getArea():e.target.getGeometry().getLength(),i=100<a?(a/1e3).toFixed(2)+"km":a.toFixed(2)+"m";s="Polygon"===t?e.target.getGeometry().getInteriorPoint().getCoordinates():e.target.getGeometry().getLastCoordinate(),l.innerHTML=i+r,o.setPosition(s)})}),n.addInteraction(M)},this.deleteMeasureLayer=function(){null!=w&&(w.getSource().clear(),w=void 0),null!=M&&(n.removeInteraction(M),M=void 0),l=null,n.removeOverlay(o),o=null},this.bindView=function(e){e&&e.getMapObj()&&e.getMapObj().setView(n.getView())},this.getMapObj=function(){return n},this.enableGetFeatureInfo=function(e){g=e=void 0===e||e,b.onclick()},this.clickPopup=function(a){if(h.innerHTML="",0!=g){a.coordinate;L.setPosition(a.coordinate);for(var e=0;e<p.length;e++){var i=p[e];if(0!=i[0]){var t=i[1].getSource().getGetFeatureInfoUrl(a.coordinate,n.getView().getResolution(),n.getView().getProjection(),{INFO_FORMAT:"text/html"});$.ajax({url:t}).done(function(e){L.setPosition(a.coordinate),h.innerHTML=h.innerHTML+e})}else b.onclick()}}},this.clickPopupAvailableLayers=function(a,e){if(h.innerHTML="",0!=g){a.coordinate;L.setPosition(a.coordinate);for(var i=0;i<p.length;i++){var t=p[i];if(0!=t[0]&&0<=$.inArray(t[0],e)){var r=t[1].getSource().getGetFeatureInfoUrl(a.coordinate,n.getView().getResolution(),n.getView().getProjection(),{INFO_FORMAT:"text/html"});$.ajax({url:r}).done(function(e){L.setPosition(a.coordinate),h.innerHTML=h.innerHTML+e})}else b.onclick()}}},this.initWithMapObjet=function(e){n=e,d.initBaseMap(),$.each(f,function(e,a){e==y&&(a.setVisible(!0),p.set(0,a)),n.addLayer(a)}),n.addOverlay(L),C()},this.addCallbackOnMoveMap=function(e){v.push(e)};var C=function(){n.on("moveend",function(e){actualExtent=n.getView().calculateExtent(n.getSize()),epsg=n.getView().getProjection().getCode(),zoom=n.getView().getZoom(),$.each(v,function(e,a){a(zoom,actualExtent,epsg)})})};this.saveCurrentMap=function(){alert("not implemented yet")},this.addLayer=function(e,a){var i=this.geoServerURL;null!=a&&(console.log("Change server by : "+a),i=a),newLayerSource=new ol.source.ImageWMS({url:i+"geoserver/ows?",serverType:"geoserver"}),newLayer=new ol.layer.Image({source:newLayerSource}),newLayer.getSource().updateParams({LAYERS:e});n.addLayer(newLayer);return u+=1,p.set(u,newLayer),u},this.onLayerLoading=function(e,a){p.get(e).getSource().on("imageloadstart",function(e){a()})},this.onLayerIsLoading=function(e,a){p.get(e).getSource().on("imageloadend",function(e){a()})},this.removeLayer=function(e){e=parseInt(e),n.removeLayer(p.get(e)),p.delete(e)},this.getCap=function(a,e){e=void 0!==e&&e;if(""==c||1==e){var i=this.geoServerURL+"geoserver/wms?request=GetCapabilities&service=WMS&version=1.3.0",t=new ol.format.WMSCapabilities;$.ajax(i).then(function(e){c=t.read(e),a(c)})}else a(c)},this.getCenterOfExtent=function(e){return[e[0]+(e[2]-e[0])/2,e[1]+(e[3]-e[1])/2]},this.setMapCenter=function(e,a){a=void 0!==a?a:"EPSG:4326";n.getView().setCenter(ol.proj.transform(d.getCenterOfExtent(e),a,"EPSG:3857"));e=ol.extent.applyTransform(e,ol.proj.getTransform(a,"EPSG:3857"));n.getView().fit(e,n.getSize())},this.setZoom=function(e){n.getView().setZoom(e)},this.zoomToLayer=function(e){layerName=p.get(e).getSource().getParams("LAYERS").LAYERS,this.getCap(function(e){var a;allLayer=e.Capability.Layer.Layer;for(var i=0,t=allLayer.length;i<t;i++){var r=allLayer[i];if(r.Name==layerName){a=r.BoundingBox[0].extent,d.setMapCenter(a);break}}})},this.zoomToLayers=function(a){var o=[];d.getCap(function(e){var n;if(allLayer=e.Capability.Layer.Layer,$.each(a,function(e,a){layerName=p.get(a).getSource().getParams("LAYERS").LAYERS;for(var i=0,t=allLayer.length;i<t;i++){var r=allLayer[i];r.Name==layerName&&(n=r.BoundingBox[0].extent,o.push(n))}}),o.length<=0)console.log("Aucune extent trouvée");else{var i=o[0];$.each(o,function(e,a){a[0]<i[0]&&(i[0]=a[0]),a[1]<i[1]&&(i[1]=a[1]),a[2]>i[2]&&(i[2]=a[2]),a[3]>i[3]&&(i[3]=a[3])}),d.setMapCenter(i)}})},this.changeOpacity=function(e,a){p.get(e).setOpacity(a)},this.changeLayerIndex=function(e,a){e=parseInt(e),p.get(e).setZIndex(a)},this.setLayerVisibility=function(e,i){$.isArray(e)?(e=e.map(parseInt),$.each(e,function(e,a){p.get(a).setVisible(i)})):d.setLayerVisibility([parseInt(e)],i)},this.updateParam=function(e,a,i){var t={};t[a]=i,p.get(e).getSource().updateParams(t)},this.getSource=function(e){return p.get(e).getSource()},this.updateDivMapSize=function(){var e=$(window).height();$("#"+d.mapDiv).height(e)},this.initBaseMap=function(){(f={}).OSM=new ol.layer.Tile({title:"OSM",preload:1/0,source:new ol.source.OSM({crossOrigin:null}),visible:!1}),f["Bing Aerial"]=new ol.layer.Tile({title:"Bing Aerial",preload:1/0,visible:!1,source:new ol.source.BingMaps({key:a,imagerySet:"Aerial"})}),f["Bing Road"]=new ol.layer.Tile({title:"Bing Road",preload:1/0,visible:!1,source:new ol.source.BingMaps({key:a,imagerySet:"Road"})}),f["Stamen Toner"]=new ol.layer.Tile({title:"Stamen Toner",preload:1/0,source:new ol.source.Stamen({layer:"toner"}),visible:!1}),f["Stamen Watercolor"]=new ol.layer.Tile({title:"Stamen Watercolor",preload:1/0,source:new ol.source.Stamen({layer:"watercolor"}),visible:!1}),f["Stamen Terrain"]=new ol.layer.Tile({title:"Stamen Terrain",preload:1/0,source:new ol.source.Stamen({layer:"terrain"}),visible:!1}),f["Mapbox Geography"]=new ol.layer.Tile({title:"Mapbox Geography",preload:1/0,source:new ol.source.TileJSON({url:"https://api.tiles.mapbox.com/v3/mapbox.geography-class.json?secure"}),visible:!1}),f["Mapbox Natural earth"]=new ol.layer.Tile({title:"Mapbox Natural earth",preload:1/0,source:new ol.source.TileJSON({url:"https://api.tiles.mapbox.com/v3/mapbox.natural-earth-hypso-bathy.json?secure"}),visible:!1})},this.getBaseMaps=function(){return f},this.changeBaseMap=function(i){$.each(d.getBaseMaps(),function(e,a){a.setVisible(!1),e==i&&(a.setVisible(!0),p.set(0,a))})}},jsonWriter=function(e){var d=this,p={},i=e;this.getJsonObj=function(){return p},this.getJsonString=function(){return JSON.stringify(p)};this.readMapCookie=function(){return function(e){for(var a=e+"=",i=document.cookie.split(";"),t=0;t<i.length;t++){for(var r=i[t];" "==r.charAt(0);)r=r.substring(1,r.length);if(0==r.indexOf(a))return r.substring(a.length,r.length)}return null}(i)},this.clearMapCookie=function(){$.removeCookie(i)},this.writeConfigCookies=function(){d.setMapName(i);var e,a=new Date;a.setFullYear(a.getFullYear()+1),e=i+"="+d.getJsonString()+"; expires="+a.toUTCString(),document.cookie=e},this.setIdMap=function(e){p.mapID=e},this.setMapName=function(e){p.mapName=e},this.geoServer=function(e){p.geoserver=e.toString(),d.writeConfigCookies()},this.ownerName=function(e){p.ownerName=e.toString(),d.writeConfigCookies()},this.userName=function(e){p.userName=e.toString(),d.writeConfigCookies()};this.lastModificationDate=function(e){p.lastModificationDate=e.toString(),d.writeConfigCookies()},this.mapName=function(e){p.mapName=e.toString(),d.writeConfigCookies()},this.mapTitle=function(e){p.mapTitle=e.toString(),d.writeConfigCookies()},this.mapID=function(e){p.mapID=e.toString(),d.writeConfigCookies()},this.shareStatus=function(e){p.shareStatus=e.toString(),d.writeConfigCookies()},this.newLayer=function(a,e,i,t,r,n,o,l){void 0===p.layers&&(p.layers=[]),a=parseInt(a);var s=p.layers.findIndex(function(e){return e.layerId===a});return-1<s||(s=p.layers.length,p.layers[s]={},p.layers[s].layerId=a,p.layers[s].layerName=e,p.layers[s].layerDisplayName=i,p.layers[s].layerGroupName=t,p.layers[s].layerOrderInGroup=r,p.layers[s].active=n,p.layers[s].visibility=o,p.layers[s].opacity=l,d.writeConfigCookies()),p.layers[s]},this.setlayerDisplayName=function(a,e){if(a=parseInt(a),!(void 0===p.layers||p.layers.findIndex(function(e){return e.layerId===a})<=-1)){var i=p.layers.findIndex(function(e){return e.layerId===a});return p.layers[i].layerDisplayName=e,d.writeConfigCookies(),p.layers[i]}},this.setLayerOrderInGroup=function(a,e){if(a=parseInt(a),!(void 0===p.layers||p.layers.findIndex(function(e){return e.layerId===a})<=-1)){var i=p.layers.findIndex(function(e){return e.layerId===a});return p.layers[i].layerOrderInGroup=e,d.writeConfigCookies(),p.layers[i]}},this.setOpacity=function(a,e){if(a=parseInt(a),!(void 0===p.layers||p.layers.findIndex(function(e){return e.layerId===a})<=-1)){var i=p.layers.findIndex(function(e){return e.layerId===a});return p.layers[i].opacity=e,d.writeConfigCookies(),p.layers[i]}},this.setActive=function(a,e){if(a=parseInt(a),!(void 0===p.layers||p.layers.findIndex(function(e){return e.layerId===a})<=-1)){var i=p.layers.findIndex(function(e){return e.layerId===a});return p.layers[i].active=e,d.writeConfigCookies(),p.layers[i]}},this.setVisibility=function(a,e){if(a=parseInt(a),!(void 0===p.layers||p.layers.findIndex(function(e){return e.layerId===a})<=-1)){var i=p.layers.findIndex(function(e){return e.layerId===a});return p.layers[i].visibility=e,d.writeConfigCookies(),p.layers[i]}},this.setOpacity=function(a,e){if(a=parseInt(a),!(void 0===p.layers||p.layers.findIndex(function(e){return e.layerId===a})<=-1)){var i=p.layers.findIndex(function(e){return e.layerId===a});return p.layers[i].opacity=e,d.writeConfigCookies(),p.layers[i]}},this.setExtent=function(e,a){p.extent=e,p.extentEPSG=a,d.writeConfigCookies()},this.setZoom=function(e){p.zoom=e},this.removeLayer=function(a){if(a=parseInt(a),!(void 0===p.layers||p.layers.findIndex(function(e){return e.layerId===a})<=-1)){var e=p.layers.findIndex(function(e){return e.layerId===a});p.layers.splice(e,1),d.writeConfigCookies()}},this.forceRemoveAllLayer=function(){p.layers=[],d.writeConfigCookies()},this.newLayerGroup=function(a,e,i,t,r){void 0===p.layerGroups&&(p.layerGroups=[]);var n=p.layerGroups.findIndex(function(e){return e.groupName===a});return-1<n||(n=p.layerGroups.length,p.layerGroups[n]={},p.layerGroups[n].groupName=a,p.layerGroups[n].groupDisplayName=e,p.layerGroups[n].groupOrder=i,p.layerGroups[n].groupActive=t,p.layerGroups[n].groupVisibility=r,d.writeConfigCookies()),p.layerGroups[n]},this.setGroupDisplayName=function(a,e){if(!(void 0===p.layerGroups||p.layerGroups.findIndex(function(e){return e.groupName===a})<=-1)){var i=p.layerGroups.findIndex(function(e){return e.groupName===a});return p.layerGroups[i].groupDisplayName=e,d.writeConfigCookies(),p.layerGroups[i]}},this.setGroupOrder=function(a,e){if(!(void 0===p.layerGroups||p.layerGroups.findIndex(function(e){return e.groupName===a})<=-1)){var i=p.layerGroups.findIndex(function(e){return e.groupName===a});return p.layerGroups[i].groupOrder=e,d.writeConfigCookies(),p.layerGroups[i]}},this.setGroupActive=function(a,e){if(!(void 0===p.layerGroups||p.layerGroups.findIndex(function(e){return e.groupName===a})<=-1)){var i=p.layerGroups.findIndex(function(e){return e.groupName===a});return p.layerGroups[i].groupActive=e,d.writeConfigCookies(),p.layerGroups[i]}},this.setGroupVisibility=function(a,e){if(!(void 0===p.layerGroups||p.layerGroups.findIndex(function(e){return e.groupName===a})<=-1)){var i=p.layerGroups.findIndex(function(e){return e.groupName===a});return p.layerGroups[i].groupVisibility=e,d.writeConfigCookies(),p.layerGroups[i]}},this.setMinmizeGroupe=function(a,e){if(!(void 0===p.layerGroups||p.layerGroups.findIndex(function(e){return e.groupName===a})<=-1)){var i=p.layerGroups.findIndex(function(e){return e.groupName===a});return p.layerGroups[i].minimize=e,d.writeConfigCookies(),p.layerGroups[i]}},this.setActiveGroup=function(a,e){if(!(void 0===p.layerGroups||p.layerGroups.findIndex(function(e){return e.groupName===a})<=-1)){var i=p.layerGroups.findIndex(function(e){return e.groupName===a});return p.layerGroups[i].groupActive=e,d.writeConfigCookies(),p.layerGroups[i]}},this.removeGroup=function(a){if(!(void 0===p.layerGroups||p.layerGroups.findIndex(function(e){return e.groupName===a})<=-1)){var e=p.layerGroups.findIndex(function(e){return e.groupName===a});p.layerGroups.splice(e,1),d.writeConfigCookies()}},this.forceRemoveAllGroup=function(){p.layerGroups=[],d.writeConfigCookies()},this.newBaseMap=function(e,a,i){return void 0!==p.baseMap||(p.baseMap={},p.baseMap.baseMapName=e,p.baseMap.opacity=a,p.baseMap.active=i,d.writeConfigCookies()),p.baseMap},this.setBaseMapName=function(e){if(void 0!==p.baseMap)return p.baseMap.baseMapName=e,d.writeConfigCookies(),p.baseMap},this.setBaseMapOpacity=function(e){if(void 0!==p.baseMap)return p.baseMap.opacity=e,d.writeConfigCookies(),p.baseMap},this.setBaseMapActive=function(e){if(void 0!==p.baseMap)return p.baseMap.active=e,d.writeConfigCookies(),p.baseMap}},layerManager=function(r,s,d,e,a,p){var u=this;this.lmDiv=r;var i=$("#"+this.lmDiv),t=$("#"+this.lmDiv).append("<div id='contenairList' class=''></div>").find("#contenairList"),n=$("#"+this.lmDiv).append("<div id='contenairConfig' class='bgColor2'></div>").find("#contenairConfig"),o=t.append("<div id='layerList' class='layer-list'></div>").find("#layerList"),l=n.append("<div id='baseMap' ></div>").find("#baseMap"),c=n.append("<div id='CRUD' ></div>").find("#CRUD");this.geoMap=s,this.jsonWriter=d,this.dimensionSlider=e,this.library=a;p=p;var f=1,y=f,v={},g=[],m={},h=1;this.getGroup=function(){return m},this.init=function(){u.geoMap.addCallbackOnMoveMap(b),void 0!==e&&(e.setCallbackUpdateParam(u.geoMap.updateParam),e.setCallbackChangeVisiblity(u.setActiveLayer))},this.removeAllLayer=function(){o.find(".layer-conf").each(function(){R($(this).attr("id"),$(this))}),f=y,u.jsonWriter.forceRemoveAllGroup(),u.jsonWriter.forceRemoveAllLayer()},this.removeLayerManager=function(){u.removeAllLayer(),i.html(""),i=$("#"+this.lmDiv),o=$("#"+this.lmDiv).append("<div id='layerList' class='layer-list'></div>").find("#layerList"),l=$("#"+this.lmDiv).append("<div id='baseMap' ></div>").find("#baseMap"),c=$("#"+this.lmDiv).append("<div id='CRUD' ></div>").find("#CRUD")};var b=function(e,a,i){u.jsonWriter.setZoom(e),u.jsonWriter.setExtent(a,i)};this.addCrud=function(e,a,i,t){divCRUD='<div class="CRUD-layer-manager">             <span class="fa-stack fa-lg fa-2x bgColor1" id="saveMap" data-toggle="tooltip" title="'+trans.layerManagerSaveMap+'">                 <i class="fa fa-floppy-o fa-stack-1x animated bgColor1 color2Hover"></i>             </span>             <span class="fa-stack fa-lg fa-2x bgColor1" id="openMap" data-toggle="tooltip" title="'+trans.layerManagerOpenMap+'">                 <i class="fa fa-folder-open-o fa-stack-1x animated  bgColor1 color2Hover"></i>             </span>             <span class="fa-stack fa-lg fa-2x bgColor1" id="addMap" data-toggle="tooltip" title="'+trans.layerManagerAddLayer+'">                 <i class="fa fa-plus fa-stack-1x animated  bgColor1 color2Hover"></i>             </span>             <span class="fa-stack fa-lg fa-2x bgColor1" id="removeAllLayers" data-toggle="tooltip" title="'+trans.layerManagerRemoveAllLayer+'">                 <i class="fa fa-trash fa-stack-1x animated bgColor1 color2Hover"></i>             </span>         </div>',newDiv=void 0!==t?$(t).append(divCRUD):c.append(divCRUD),newDiv.find("#saveMap").click(function(){a(u.jsonWriter.getJsonString())}),newDiv.find("#openMap").click(function(){i(u.loadJsonMap)}),newDiv.find("#addMap").click(function(){e()}),newDiv.find("#removeAllLayers").click(function(){confirm(trans.layerManagerConfirmRemoveAll)&&u.removeAllLayer()}),c=newDiv},this.addLayer=function(e,a,i,t,r){console.log(e+" - "+a+" - "+i+" - "+t+" - "+r),layerCap=u.library.getLayerCapabilities(e),""!=a&&void 0!==a||(a=void 0===layerCap||void 0===layerCap.Title||""==layerCap.Title?e:layerCap.Title),""!=i&&void 0!==i||(i=trans.standardGroupName),groupDiv=w(i,t);var n=groupDiv.attr("id");actualOrderGroup=groupDiv.data("ordergroup");var o=(groupDiv.find(".layer-conf").length+1)/1e3;thisOrder=actualOrderGroup+o;var l=0;return $.each(Q(n),function(e,a){u.dimensionSlider.updateLayer(a);var i=u.getOrderLayer(a);l<i&&(l=i)}),999<=(l=1e3*l-1e3*parseInt(l))?(console.log("Le nombre maxi de couche dans le groupe à été atteint"),null):"undefined"==typeof layerCap||null===layerCap?(console.log("Error : Le layer "+e+" n'est pas disponible"),newDiv=D(thisOrder,e),groupDiv.find("#layers").prepend(newDiv),E(thisOrder,newDiv),null):(idLayer=s.addLayer(e,r),u.setOrderLayer(idLayer,thisOrder),idLayer=parseInt(idLayer),v[idLayer]=layerCap,g.push([idLayer,e,a,i]),newDiv=O(idLayer,e,a,thisOrder),groupDiv.find("#layers").prepend(newDiv),u.sortDivGroup(),void 0!==u.dimensionSlider&&(u.dimensionSlider.sliderAddLayer(idLayer,layerCap),u.dimensionSlider.updateElevSlider(idLayer),u.dimensionSlider.updateTimeSlider(idLayer)),u.setActiveLayer(idLayer,p.defaultLayerActive),u.setOpacity(idLayer,p.defaultOpacity),d.newLayer(idLayer,e,a,n,thisOrder,!0,!0,1),A(idLayer,newDiv),_(idLayer,newDiv),V(idLayer,newDiv),I(idLayer,newDiv),E(idLayer,newDiv),N(idLayer,newDiv),z(idLayer,newDiv),B(idLayer,newDiv),L(idLayer,newDiv),M(idLayer,newDiv),idLayer)};var L=function(e,a){u.geoMap.onLayerLoading(e,function(){$(a).find(".loadingLayer").show(),$(a).find("#eyeVisibility").hide()})},M=function(e,a){u.geoMap.onLayerIsLoading(e,function(){$(a).find(".loadingLayer").hide(),$(a).find("#eyeVisibility").show()}),$('[data-toggle="tooltip"]').tooltip()},w=function(e,a){var i=m[e];if(null!=i&&""!=i){var t=o.find(".group-div#"+i);if(t.length)return t}var r=C(e,a);return o.prepend(r),r},C=function(e,a){return h+=1,m[e]=h,f+=1,actualGroupOrder=f,null!=a&&-1<a&&(actualGroupOrder=a,f<a&&(f=a+1)),r=S(h,actualGroupOrder,e),F(h,r),J(h,r),k(h,r),Y(h,r),Z(h,r),U(h,r),H(h,r),u.jsonWriter.newLayerGroup(h,e,actualGroupOrder,!0,!0),$(r)},S=function(e,a,i){return r='<div class="group-div" id="'+e+'" data-ordergroup="'+a+'"><div class="group"><table width="100%" cellpadding="0" cellmargin="0" class="layer-conf "><tr><td class="cola"></td><td class="col2"></td><td class="col2b"></td><td class="col3 bgColor2Darker borderBottomColor2Darker"></td></tr></table></div><div id="layers"></div></div>',eyeVisibility='<i id="gpEyeVisibility" class="fa fa-eye group-eye-visibility bgColor2" aria-hidden="true" data-toggle="tooltip" title="'+trans.hideGroup+'"></i>',minusGroup='<i id="gpMinus" class="fa fa-minus group-minus bgColor2" aria-hidden="true" data-toggle="tooltip" title="'+trans.hideGroup+'"></i>',label='<div class="group-name"><label Color2><b>'+i+"</b></label></div>",zoomOn='<i class="fa fa-search-plus group-zoom Color2" aria-hidden="true" id="zoomOn" data-toggle="tooltip" title="'+trans.zoomGroup+'"></i>',up='<i class="fa fa-chevron-up Color2" aria-hidden="true" id="upGroup" data-toggle="tooltip" title="'+trans.upGroup+'"></i>',down='<i class="fa fa-chevron-down Color2" aria-hidden="true" id="downGroup" data-toggle="tooltip" title="'+trans.upGroup+'"></i>',deleteGroup='<i class="fa fa-trash trash-group bgColor2" aria-hidden="true" id="trashGroup" data-toggle="tooltip" title="'+trans.deleteGroup+'"></i>',newDiv=$(r),newDiv.find(".cola").append(eyeVisibility).append(minusGroup),newDiv.find(".col2").append(label),newDiv.find(".col2b").append(zoomOn).append(up).append(down),newDiv.find(".col3").append(deleteGroup),newDiv},k=function(i,t){var r=t;$(t).find(".group-name").find("label").unbind("click"),$(t).find(".group-name").find("label").click(function(){var a=$(this).text(),e='<input value="'+a+'"></input>';$(this).replaceWith(e),$(t).find(".group-name").find("input").focus(),$(t).find(".group-name").find("input").keypress(function(e){"13"==(e.keyCode?e.keyCode:e.which)&&G(i,a,$(this),r)}),$(t).find(".group-name").find("input").focusout(function(){G(i,a,$(this),r)})})},G=function(e,a,i,t){var r=$(i).val();void 0!==m[r]&&r!=a?(alert("Ce group existe déjà"),r=a):(m[r]=m[a],delete m[a]);var n="<label><b>"+r+"</b></label>";u.jsonWriter.setGroupDisplayName($(t).attr("id"),r),$(i).replaceWith(n),k(e,t)};this.getAllActiveLayer=function(){var i=[];return $.each(g,function(e,a){u.getActiveLayer(a[0])&&i.push(a)}),i},this.loadLibraryLayers=function(e,i){$.each(e,function(e,a){u.addLayer(a,"",i)})};var O=function(e,a,i,t){return r='<div class="layer-conf" id="'+e+'" data-layer="'+a+'" data-orderLayer="'+t+'"><table width="100%" cellpadding="0" cellmargin="0"><tr><td class="col1"></td><td class="col2"><div class="row line1"></div><div class="row line2 animated"></div></td><td class="col3 bgColor2Darker borderBottomColor2Darker"></td></tr></table></div>',eyeVisibility='<i id="eyeVisibility" class="fa fa-eye eye-visibility color2darker" aria-hidden="true"  data-toggle="tooltip" data-layer="'+a+'" title="'+trans.hideLayer+'"></i>',loadingLayer='<i class="fa fa-spinner fa-spin fa-fw loadingLayer" id="'+e+'" style="display:none;"></i>',label=x(i),updownLayer='<i class="fa fa-chevron-up color1" aria-hidden="true" id="upLayer" data-toggle="tooltip" title="'+trans.upLayer+'"></i><i class="fa fa-chevron-down color1" aria-hidden="true" id="downLayer"  data-toggle="tooltip" title="'+trans.downLayer+'"></i>',deleteLAyer='<i class="fa fa-trash trash-layer color1" aria-hidden="true" id="trashLayer" data-toggle="tooltip" title="'+trans.deleteLayer+'"></i>',extractMenu=j(),separator='<span class="separator"></span>',zoomOn='<i class="fa fa-search-plus zoom-layer color1" aria-hidden="true" id="zoomOn" data-toggle="tooltip" title="'+trans.zoomLayer+'"></i>',opacitySlider='<input id="opacity"/><span class="opacity-percent" id="opacityPercent"></span>',legend='<i class="fa fa-list get-legend color1" aria-hidden="true" id="getLegend" data-img="'+v[e].Style[0].LegendURL[0].OnlineResource+'"></i>',newDiv=$(r),newDiv.find(".col1").append(eyeVisibility).append(loadingLayer),newDiv.find(".col2 .line1").append(label),newDiv.find(".col2 .line2").append(separator).append(opacitySlider).append(zoomOn).append(legend).append(updownLayer),newDiv.find(".col3").append(deleteLAyer),newDiv.find("#opacity").slider({id:"opacitySlider",class:"gh-slider",value:1,step:.05,min:0,max:1,tooltip:"hide"}),newDiv},D=function(e,a){return r='<div class="layer-conf" id="'+e+'" data-layer="'+a+'" data-orderLayer="-1"><table width="100%" cellpadding="0" cellmargin="0"><tr><td class="col1"></td><td class="col2"><div class="row line1"></div><div class="row line2 animated"></div></td><td class="col3 bgColor2Darker borderBottomColor2Darker"></td></tr></table></div>',eyeVisibility='<i id="eyeVisibility" class="fa fa-eye-slash eye-visibility color2darker" aria-hidden="true"  data-toggle="tooltip" title="'+trans.hidenLayer+'"></i>',label=x(a.replace(/\_/g," ")),unavailableLabel='<label class="col-md-10 animated color2 unavailableLabel">'+trans.unavailableLayer+"</label>",deleteLAyer='<i class="fa fa-trash trash-layer color1" aria-hidden="true" id="trashLayer" data-toggle="tooltip" title="'+trans.deleteLayer+'"></i>',newDiv=$(r),newDiv.find(".col1").append(eyeVisibility),newDiv.find(".col2 .line1").append(label),newDiv.find(".col2 .line2").append(unavailableLabel),newDiv.find(".col3").append(deleteLAyer),newDiv},x=function(e){return'<label class="col-md-10 animated labelLayerName"><b>'+e+"</b></label>"},j=function(){return'<div class="dropdown extract-menu pull-right">             <i class="fa fa-ellipsis-h dropdown-toggle" data-toggle="dropdown" aria-hidden="true" id="extractMenu"></i>             <ul class="dropdown-menu pull-left" role="menu" style="left:auto;">                 <li><a href="#">Renommer la couche</a></li>                 <li><a href="#">Autre action</a></li>             </ul>         </div>'};this.createBaseMap=function(){return r='<div class="form-group base-map layer-conf" id="0"><table width="100%"><tr><td class="col1 bgColor2Darker"></td><td class="col2 animated"></td></tr></table></div>',eyeVisibility='<i id="eyeVisibility" class="fa fa-eye eye-visibility color2darker" aria-hidden="true"  data-toggle="tooltip" title="'+trans.layerManagerHideMapBackground+'"></i>',baseMaps=$('<select class="form-control animated" id="baseMapSelect">'),defaultBaseMapName="",$.each(u.geoMap.getBaseMaps(),function(e,a){value=e.split(" ").join("_");var i=$("<option value="+value+">"+e+"</option>");a.getVisible()&&(i.attr("selected",!0),defaultBaseMapName=e),baseMaps=baseMaps.append(i)}),baseMaps=baseMaps.append("</select>"),opacitySlider='<input id="opacity"/><span class="opacity-percent" id="opacityPercent"></span>',newDiv=$(r),newDiv.find(".col1").append(eyeVisibility),newDiv.find(".col2").append(baseMaps).append(opacitySlider),newDiv.find("#opacity").slider({id:"opacitySlider",value:1,step:.05,min:0,max:1,tooltip:"hide"}),l.append(newDiv),u.setActiveLayer(0,p.defaultLayerActive),u.setOpacity(0,p.defaultOpacity),A(0,newDiv),I(0,newDiv),W(newDiv),u.jsonWriter.newBaseMap(defaultBaseMapName,1,!0),newDiv};var I=function(e,a){$(a).find("#eyeVisibility").click(function(){0!=u.getActiveGroupByIdLayer(e)&&(u.setActiveLayer(e,!$(this).hasClass("fa-eye")),void 0!==u.dimensionSlider&&$(this).hasClass("fa-eye")&&u.dimensionSlider.updateLayer(e))})},N=function(e,a){$(a).find("#zoomOn").click(function(){u.geoMap.zoomToLayer(e)})},A=function(e,a){$(a).find("#opacity").change(function(){u.setOpacity(e,$(this).val())})},_=function(i,t){$(t).find("#upLayer").click(function(){var e=parseFloat(t.attr("data-orderLayer")),a=t.prev(".layer-conf");a.hasClass("layer-conf")&&(newOrderLayer=parseFloat(a.attr("data-orderLayer")),u.setOrderLayer(a.attr("id"),e),u.setOrderLayer(i,newOrderLayer),u.sortDivLayer())})},V=function(i,t){$(t).find("#downLayer").click(function(){var e=parseFloat(t.attr("data-orderLayer")),a=t.next(".layer-conf");a.hasClass("layer-conf")&&(newOrderLayer=parseFloat(a.attr("data-orderLayer")),u.setOrderLayer(a.attr("id"),e),u.setOrderLayer(i,newOrderLayer),u.sortDivLayer())})},B=function(e,a){var i=e,t=a;$(a).find(".labelLayerName").unbind("click"),$(a).find(".labelLayerName").click(function(){var e='<input class="inputLayerLayerName" value="'+$(this).text()+'"></input>';$(this).replaceWith(e),$(a).find(".inputLayerLayerName").focus(),$(a).find(".inputLayerLayerName").keypress(function(e){"13"==(e.keyCode?e.keyCode:e.which)&&T($(this),i,t)}),$(a).find(".inputLayerLayerName").focusout(function(){T($(this),i,t)})})},T=function(e,a,i){var t=$(e).val(),r=x(t);u.jsonWriter.setlayerDisplayName(a,t),$(e).replaceWith(r),B(a,i)},E=function(e,a){$(a).find("#trashLayer").click(function(){R(e,a)})},W=function(e){$(e).change(function(){var e=$(this).find("option:selected").text(),a=l.find("#opacity").val(),i=u.getActiveLayer(0);u.setBaseMap(e),u.setActiveLayer(0,i),u.setOpacity(0,a)})},z=function(e,a){$(a).find("#getLegend").popover({html:!0,trigger:"hover",placement:"bottom",content:function(){return'<img src="'+$(this).data("img")+'" />'}})},R=function(e,a){u.geoMap.removeLayer(e),u.jsonWriter.removeLayer(e),$(a).toggle(function(){$(this).remove(),P()}),void 0!==u.dimensionSlider&&(u.dimensionSlider.sliderRemoveLayer(e,v[e]),u.dimensionSlider.updateElevSlider(e),u.dimensionSlider.updateTimeSlider(e))},P=function(){o.find(".group-div").each(function(){if($(this).find("#layers").find(".layer-conf").length<=0){$(this).remove();var i=$(this).attr("id");u.jsonWriter.removeGroup(i);var t=void 0;$.each(m,function(e,a){a==i&&(t=e)}),t&&delete m[t]}})},F=function(a,e){$(e).find("#zoomOn").click(function(){var e=Q(a);u.geoMap.zoomToLayers(e)})},U=function(i,t){$(t).find("#upGroup").click(function(){var e=parseFloat(t.attr("data-ordergroup")),a=t.prev(".group-div");a.hasClass("group-div")&&(newOrderGroup=parseFloat(a.attr("data-ordergroup")),u.setOrderGroup(a.attr("id"),e),u.setOrderGroup(i,newOrderGroup),u.sortDivGroup())})},H=function(i,t){$(t).find("#downGroup").click(function(){var e=parseInt(t.attr("data-ordergroup")),a=t.next(".group-div");a.hasClass("group-div")&&(newOrderGroup=parseFloat(a.attr("data-ordergroup")),u.setOrderGroup(a.attr("id"),e),u.setOrderGroup(i,newOrderGroup),u.sortDivGroup())})},J=function(e,a){$(a).find("#gpMinus").click(function(){u.setMinimizeGroup(e,!$(this).hasClass("fa-plus"))})},Z=function(e,a){$(a).find("#gpEyeVisibility").click(function(){u.setActiveGroup(e,!$(this).hasClass("fa-eye")),void 0!==u.dimensionSlider&&$(this).hasClass("fa-eye")&&$.each(Q(e),function(e,a){u.dimensionSlider.updateLayer(a)})})},Y=function(e,a){$(a).find("#trashGroup").click(function(){X(e).each(function(){R($(this).attr("id"),$(this))}),P()})},X=function(e){return o.find(".group-div#"+e).find("#layers").find(".layer-conf")},Q=function(e){var a=[];return X(e).each(function(){a.push(parseInt($(this).attr("id")))}),a};this.setOpacity=function(e,a){1<a&&(a=1),a<0&&(a=0);var i=o;0==e&&(i=l),r=i.find(".layer-conf#"+e).find("#opacity").slider("setValue",a),i.find(".layer-conf#"+e).find("#opacityPercent").text(parseInt(100*a)+" %"),u.geoMap.changeOpacity(e,a),u.jsonWriter.setOpacity(e,a),0<e?u.jsonWriter.setOpacity(e,a):u.jsonWriter.setBaseMapOpacity(a)},this.setActiveLayer=function(e,a){var i=o;0==e&&(i=l),a?(i.find(".layer-conf#"+e).find("#eyeVisibility").removeClass("fa-eye-slash").addClass("fa-eye"),i.find(".layer-conf#"+e).find("#eyeVisibility").attr("title",trans.hideLayer),i.find(".layer-conf#"+e).find("#eyeVisibility").attr("data-original-title",trans.hideLayer),0==e&&(i.find(".layer-conf#"+e).find("#eyeVisibility").attr("title",trans.layerManagerHideMapBackground),i.find(".layer-conf#"+e).find("#eyeVisibility").attr("data-original-title",trans.layerManagerHideMapBackground)),i.find(".layer-conf#"+e).removeClass("inactiveLayer")):(i.find(".layer-conf#"+e).find("#eyeVisibility").removeClass("fa-eye").addClass("fa-eye-slash"),i.find(".layer-conf#"+e).find("#eyeVisibility").attr("title",trans.showLayer),i.find(".layer-conf#"+e).find("#eyeVisibility").attr("data-original-title",trans.showLayer),0==e&&(i.find(".layer-conf#"+e).find("#eyeVisibility").attr("title",trans.layerManagerShowMapBackground),i.find(".layer-conf#"+e).find("#eyeVisibility").attr("data-original-title",trans.layerManagerShowMapBackground)),i.find(".layer-conf#"+e).addClass("inactiveLayer")),u.geoMap.setLayerVisibility(e,a),0<e?u.jsonWriter.setActive(e,a):u.jsonWriter.setBaseMapActive(a)},this.setActiveGroup=function(e,i){i?o.find(".group-div#"+e).find(".group").find("#gpEyeVisibility").removeClass("fa-eye-slash").addClass("fa-eye"):o.find(".group-div#"+e).find(".group").find("#gpEyeVisibility").removeClass("fa-eye").addClass("fa-eye-slash"),$.each(Q(e),function(e,a){i?u.getActiveLayer(a)&&(u.geoMap.setLayerVisibility(a,i),o.find(".layer-conf#"+a).removeClass("inactiveLayer")):(u.geoMap.setLayerVisibility(a,i),o.find(".layer-conf#"+a).addClass("inactiveLayer"))}),u.jsonWriter.setActiveGroup(e,i)},this.setOrderLayer=function(e,a){o.find(".layer-conf#"+e).attr("data-orderLayer",a),u.jsonWriter.setLayerOrderInGroup(e,a),u.geoMap.changeLayerIndex(e,a)},this.getOrderLayer=function(e){return o.find(".layer-conf#"+e).attr("data-orderLayer")},this.setOrderGroup=function(e,r){$.each(Q(e),function(e,a){var i=parseFloat(o.find(".layer-conf#"+a).attr("data-orderLayer")),t=i+parseInt(parseInt(r)-parseInt(i));u.setOrderLayer(a,t)}),o.find(".group-div#"+e).attr("data-ordergroup",r),u.jsonWriter.setGroupOrder(e,r)},this.setBaseMap=function(e){u.geoMap.changeBaseMap(e);var a=e.split(" ").join("_");l.find("select").val(a),u.jsonWriter.setBaseMapName(e)},this.getActiveGroup=function(e){return o.find(".group-div#"+e).find(".group").find("#gpEyeVisibility").hasClass("fa-eye")},this.getActiveGroupByIdLayer=function(e){var a=o.find(".layer-conf#"+e).closest(".group-div").attr("id");return u.getActiveGroup(a)},this.getActiveLayer=function(e){var a=o;return 0==e&&(a=l),a.find(".layer-conf#"+e).find("#eyeVisibility").hasClass("fa-eye")},this.getEyeVisibility=function(e){var a=o;return 0==e&&(a=l),a.find(".layer-conf#"+e).find("#eyeVisibility").hasClass("fa fa-eye")},this.sortDivLayer=function(){o.find(".group-div").each(function(){var e=$(this).find("#layers");e.children("div").sort(function(e,a){return $(e).attr("data-orderLayer")-$(a).attr("data-orderLayer")}).each(function(){e.prepend(this)})})},this.sortDivGroup=function(){o.children(".group-div").sort(function(e,a){return $(e).attr("data-ordergroup")-$(a).attr("data-ordergroup")}).each(function(){o.prepend(this)})},this.setMinimizeGroup=function(e,a){a?(o.find(".group-div#"+e).find(".group").find("#gpMinus").removeClass("fa-minus").addClass("fa-plus"),o.find(".group-div#"+e).find("#layers").hide("slow")):(o.find(".group-div#"+e).find(".group").find("#gpMinus").removeClass("fa-plus").addClass("fa-minus"),o.find(".group-div#"+e).find("#layers").show("slow")),u.jsonWriter.setMinmizeGroupe(e,a)},this.checkMapCookies=function(){var e=u.jsonWriter.readMapCookie();""!=e&&u.loadJsonMap(e)},this.loadJsonMap=function(e){if(jsonObj=JSON.parse(e),u.removeAllLayer(),u.dimensionSlider.resetDimensionSlider(),null!=jsonObj&&""!=jsonObj){if(void 0!==jsonObj.mapName&&""!=jsonObj.mapName&&(p.mapName=jsonObj.mapName),""==jsonObj.layers&&void 0===jsonObj.layers||($.each(jsonObj.layers,function(e,i){var t=void 0;""==jsonObj.layerGroups&&void 0===jsonObj.layerGroups||$.each(jsonObj.layerGroups,function(e,a){a.groupName==i.layerGroupName&&(t=a.groupDisplayName)});var a=u.addLayer(i.layerName,i.layerDisplayName,t);if(null==a)return!0;u.setActiveLayer(a,i.active),u.setOpacity(a,i.opacity),u.setOrderLayer(a,i.layerOrderInGroup)}),u.sortDivLayer()),""==jsonObj.layerGroups&&void 0===jsonObj.layerGroups||$.each(jsonObj.layerGroups,function(e,a){var i=w(a.groupDisplayName).attr("id");u.setActiveGroup(i,a.groupActive),u.setMinimizeGroup(i,a.minimize)}),""!=jsonObj.baseMap||void 0!==jsonObj.baseMap){var a=jsonObj.baseMap.baseMapName,i=jsonObj.baseMap.opacity,t=jsonObj.baseMap.active;u.setBaseMap(a),u.setActiveLayer(0,t),u.setOpacity(0,i)}jsonObj.extent&&jsonObj.extentEPSG&&u.geoMap.setMapCenter(jsonObj.extent,jsonObj.extentEPSG),jsonObj.zoom&&u.geoMap.setZoom(jsonObj.zoom)}else console.log("Erreur de chargement de la jsonMap")},this.updateDivLayerListSize=function(e){var a=e;o.css("max-height",a)}},library=function(e,l,a){var s=this;this.modalDiv=e;var d=$("#"+e);this.workspaceLimit=a;l=l;var p={};this.createModalListLayer=function(){var e=i();d.append(e),d.find("#groupName").on("keypress",function(e){13===e.keyCode&&d.find("#add_layers").trigger("click")});var o=new ol.format.WMSCapabilities;$.each(s.workspaceLimit,function(e,a){var i=a.split(":"),n=i[0],t=n;1<i.length&&(i.shift(),t=i.join(":"));var r=l+"geoserver/"+n+"/wms?service=wms&version=1.3.0&request=GetCapabilities";$.ajax(r).done(function(e){if(getCapabilitiesLib=o.read(e),null!=getCapabilitiesLib.Capability.Layer.Layer){var a=u(n,t,getCapabilitiesLib.Capability.Layer.Layer.length);d.find(".modal-body").append(a),c(n),allLayer=getCapabilitiesLib.Capability.Layer.Layer,$.each(allLayer,function(e,a){var i=a.Name,t=a.Title,r=f(n,i,t);p[n+":"+i]=a,d.find(".modal-body").find("#"+n).find(".list-layers").append(r)}),y(d.find(".modal-body").find("#"+n)),s.sortDivWorkspace()}else console.log("Error with cap-worksapce : "+n)}).fail(function(){console.log("Faild to load workspace : \t"+n)})})},this.getLayerCapabilities=function(e){return p[e]},this.openLibrary=function(){d.find("#modalAddLayer").modal("show")},this.addLayers=function(i){d.find("#add_layers").click(function(){var e=[];d.find("#modalAddLayer #layer input[type='checkbox']").each(function(){$(this).is(":checked")&&(1,layer=$(this).closest("#layer").data("layer"),workspace=$(this).closest("#layer").data("workspace"),e.push(workspace+":"+layer))});var a=d.find("#modalAddLayer .modal-footer .group-name #groupName").val();i(e,a),d.find("#modalAddLayer").modal("hide"),d.find("#modalAddLayer input[type='checkbox']").each(function(){$(this).is(":checked")&&$(this).prop("checked",!1)}),d.find("#modalAddLayer .panel-collapse").each(function(){$(this).collapse("hide")})})};var i=function(){return'<div class="modal fade" id="modalAddLayer" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">         <div class="modal-dialog">             <div class="modal-content">                 <div class="modal-header">                     <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>                     <h4 class="modal-title" id="myModalLabel">'+trans.layerLibrary+'</h4>                 </div>                 <div class="modal-body">                 </div>                 <div class="modal-footer">                     <div class="input-group group-name">                         <span class="input-group-addon">'+trans.newGroupName+'</span>                         <input id="groupName" type="text" class="form-control" name="msg" placeholder="'+trans.standardGroupName+'">                     </div>                     <button type="button" class="btn btn-default cancel" data-dismiss="modal">'+trans.cancel+'</button>                     <button type="button" class="btn btn-primary" id="add_layers">'+trans.loadLayers+"</button>                 </div>             </div>         </div>     </div>"},u=function(e,a,i){return'<div class="panel-group" id="'+e+'" data-display-name="'+a+'">       <div class="panel panel-primary">         <div class="panel-heading bgColor2Darker">           <h4 class="panel-title">             <input type="checkbox" id="selectWorkspaceLayers">             <span data-toggle="collapse" class="workspace-link" href="#collapse_'+s.modalDiv+e+'">                 <b>'+a+'</b>                 <span class="left-separator borderColor2"></span>                 <span class="label label-default bgColor2">'+i+'</span>                <i class="fa fa-map-o layer-icon" aria-hidden="true"></i>                 <i class="fa fa-plus open-workspace"></i>            </span>           </h4>         </div>         <div id="collapse_'+s.modalDiv+e+'" class="panel-collapse collapse">           <ul class="list-group list-layers">           </ul>           <div class="panel-footer"></div>         </div>       </div>     </div>'},c=function(e){d.find("#collapse_"+s.modalDiv+e).on("shown.bs.collapse",function(){d.find(".panel-group#"+e+" .workspace-link .open-workspace").removeClass("fa-plus").addClass("fa-minus")}),d.find("#collapse_"+s.modalDiv+e).on("hidden.bs.collapse",function(){d.find(".panel-group#"+e+" .workspace-link .open-workspace").removeClass("fa-minus").addClass("fa-plus")})},f=function(e,a,i){return""!=i&&null!=i||(i=a),'<li class="list-group-item" id="layer" data-layer="'+a+'" data-workspace="'+e+'">         <label for="'+a+'">              <input type="checkbox" id="'+a+'">             <div class="layer-description">                 <i class="fa fa-map-o layer-icon" aria-hidden="true"></i>                 <strong>'+i+"</strong><br/>"+a+"            </div>        </label>        </li>"},y=function(e){e.find("#selectWorkspaceLayers").click(function(){var e=$(this).prop("checked");$(this).parent().parent().parent().find(".list-layers").find("input").each(function(){$(this).prop("checked",e)})})};this.sortDivWorkspace=function(){d.find(".panel-group").sort(function(e,a){return $(e).attr("data-display-name")<$(a).attr("data-display-name")}).each(function(){d.find(".modal-body").prepend(this)})}},mapLayer=function(e){var a,r={lang:"en",map:{divMap:"map",geoMapConfig:{defaultBaseMap:"OSM",defaultXCenter:2,defaultYCenter:48,defaultZoomLevel:5},geoserverName:"<yourGeoServerURL>",workspaceLimit:["<workspaceName[:workspaceDisplayName]>","<workspaceName[:workspaceDisplayName]>"],keyBING:"<yourBingKey>"},layerManager:{height:"",divLayerManagerModal:"layerManagerModal",divLayerManager:"layerManager",divSaveMapModal:"LMSaveMapModal",config:{defaultOpacity:1,defaultLayerActive:!0}},dynSlider:{divMapLevelAxe:"slider_elev",divMapTimeAxe:"slider_time"}};"object"==typeof e&&(a=e,$.each(a,function(t,e){"object"==typeof r[t]?$.each(a[t],function(i,e){"object"==typeof r[t][i]?$.each(a[t][i],function(e,a){r[t][i][e]=a}):r[t][i]=e}):r[t]=e}));var i=this;(e=r).layerManager.config;i.map=new geoMap(e.map.divMap,e.map.geoserverName,e.map.keyBING),i.myJsonWriter=new jsonWriter,i.myDimensionSlider=new dimensionSlider(e.dynSlider.divMapLevelAxe,e.dynSlider.divMapTimeAxe),i.myLibrary=new library(e.layerManager.divLayerManagerModal,e.map.geoserverName,e.map.workspaceLimit),i.layerManager=new layerManager(e.layerManager.divLayerManager,i.map,i.myJsonWriter,i.myDimensionSlider,i.myLibrary,e.layerManager.config),i.saveLoadMap=new saveLoadMap(e.layerManager.divSaveMapModal,[],"#",""),i.map.initMap(e.map.geoMapConfig),i.layerManager.init(),i.myLibrary.createModalListLayer(),i.layerManager.createBaseMap(),i.saveLoadMap.init(),i.layerManager.addCrud(i.myLibrary.openLibrary,i.saveLoadMap.openSaveMapModal,i.saveLoadMap.openLoadMapModal),i.myLibrary.addLayers(i.layerManager.loadLibraryLayers),$('[data-toggle="tooltip"]').tooltip(),$(window).resize(function(){""===e.layerManager.height?i.layerManager.updateDivLayerListSize($(window).height()-$("#contenairConfig").height()-$(".layer-manager-title").outerHeight()-$(".map-title-first").outerHeight()):i.layerManager.updateDivLayerListSize(e.layerManager.height),i.map.updateDivMapSize}).resize()},saveLoadMap=function(e,a,i,t){i=i,e=e,a=a,t=t;var r,n=$("#"+e).append("<div id='saveModal'></div>").find("#saveModal"),o=$("#"+e).append("<div id='loadModal'></div>").find("#loadModal");this.init=function(){n.append(d()),o.append(p()),$.each(a,function(e,a){o.find("#listMap").append('<option value="'+a.id+'">'+a.mapname+"</option>")}),n.find("#modalSaveMap").find("#btn-save-map").click(function(){var e=n.find("#modalSaveMap").find("#nameMapSave").val(),a=n.find("#modalSaveMap").find("#jsonMapSave").val();l(e+".json",a),n.find("#modalSaveMap").modal("hide"),n.find("#formJsonMapSave")[0].reset()}),o.find("#modalLoadMap").find("#btn-load-map").click(function(){s(r),o.find("#loadJsonFile")[0].reset()})},this.openSaveMapModal=function(e){n.find("#modalSaveMap").modal("show"),n.find("#modalSaveMap").find("#jsonMapSave").val(e)};var l=function(e,a){var i=document.createElement("a");if(i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a)),i.setAttribute("download",e),document.createEvent){var t=document.createEvent("MouseEvents");t.initEvent("click",!0,!0),i.dispatchEvent(t)}else i.click()};this.openLoadMapModal=function(e){r=e,o.find("#modalLoadMap").modal("show")};var s=function(a){var e,i,t;"function"==typeof window.FileReader?(e=document.getElementById("files"))&&(e.files?e.files[0]?(i=e.files[0],(t=new FileReader).onload=function(e){lines=e.target.result,a(lines)},t.readAsText(i)):alert(trans.errorSelectFile):alert(trans.browserNotSupported)):alert(trans.apiNotSupported)},d=function(){return'<div class="modal fade" id="modalSaveMap" role="dialog" aria-labelledby="myModalSaveLabel" aria-hidden="true">         <div class="modal-dialog">             <div class="modal-content">                 <form id="formJsonMapSave" role="form" method="POST" action="'+i+'">                     <div class="modal-header">                         <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">'+trans.close+'</span></button>                         <h4 class="modal-title" id="myModalSaveLabel">'+trans.saveMap+'</h4>                     </div>                     <div class="modal-body">                         <input type="text" name="nameMapSave" id="nameMapSave" class="form-control" maxlength="200" />                          <input type="hidden" name="jsonMapSave" id="jsonMapSave" class="form-control" />                         <input type="hidden" name="statusSave" id="statusSave" class="form-control" value="public"/>                          <input type="hidden" name="idCurrentSave" id="idCurrentSave" class="form-control" value="1"/>                          <input type="hidden" name="_token" value="'+t+'">                    </div>                     <div class="modal-footer">                         <button type="button" class="btn btn-default pull-left" data-dismiss="modal">'+trans.cancel+'</button>                         <button type="button" id="btn-save-map" class="btn btn-primary pull-right">'+trans.save+"</button>                     </div>                 </form>             </div>         </div>     </div>"},p=function(){return'<div class="modal fade" id="modalLoadMap" role="dialog" aria-labelledby="myModalLoadLabel" aria-hidden="true">         <div class="modal-dialog">             <div class="modal-content"> \t\t\t\t<form id="loadJsonFile" name="jsonFile" enctype="multipart/form-data" method="post"> \t\t\t\t\t<div class="modal-header"> \t\t\t\t\t\t<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">'+trans.close+'</span></button> \t\t\t\t\t\t<h4 class="modal-title" id="myModalLoadLabel">'+trans.loadMap+'</h4> \t\t\t\t\t</div> \t\t\t\t\t<div class="modal-body"> \t\t\t\t\t\t\t<input type="file" id="files" name="file" /> \t\t\t\t\t</div> \t\t\t\t\t<div class="modal-footer"> \t\t\t\t\t\t<button type="button" class="btn btn-default pull-left" data-dismiss="modal">'+trans.cancel+'</button> \t\t\t\t\t\t<button type="button" id="btn-load-map" data-dismiss="modal" class="btn btn-primary pull-right">'+trans.load+"</button> \t\t\t\t\t</div> \t\t\t\t</form>             </div>         </div>     </div>"}},majNameInputFile=function(e,a,i){var t=$("#"+e);if(!(t.val().length<=0)){var r=t.val().replace(/\\/g,"/").replace(/.*\//,"");$("#"+a).text(" - "+r),$("#"+i).show()}};function progress(e,a,i){var t=Math.floor(100*i/a);$("#"+e+" span").html(trans.Uploadinprogress+" : "+t+"%"),100<=t&&$("#"+e+" span").text(trans.ServerTreatment)}var uploadFile=function(e){$("form#"+e).submit(function(e){var a=$(this).attr("action");if(0!=$("#inputfile").get(0).files.length){var i=new FormData(this);$(this).find(":input").each(function(){$(this).prop("disabled",!0)}),$.ajax({url:a,cache:!1,contentType:!1,processData:!1,data:i,type:"post",headers:{"X-XSRF-TOKEN":$('form#upload_file_form input[name="_token"]').val()},xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){progress("sbmitUpload",e.total,e.loaded)},!1),e},success:function(){$("#sbmitUpload span").text(trans.successTreatment),$("#loader-finsh-spinner").show()},fail:function(){$("#loader-error-spinner").show(),console.log("Upload error")}}).always(function(){console.log("FIN"),$("#sbmitUpload span").text(trans.Uploadnewfile),$("form#upload_file_form :input").each(function(){$(this).prop("disabled",!1)})})}})};